<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoi d'Email - GPA Assurance</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 5px;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-secondary {
            background-color: #95a5a6;
            margin-right: 10px;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: none;
            margin: 10px 0;
            color: #666;
        }
        .attachments {
            margin: 15px 0;
        }
        .attachment-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border: 1px dashed #dee2e6;
            border-radius: 4px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-attachment {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìß Envoyer un Email</h1>
        
        <div id="status" class="status"></div>
        
        <form id="emailForm">
            <div class="form-group">
                <label for="to">Destinataire :</label>
                <input type="email" id="to" name="to" required>
            </div>
            
            <div class="form-group">
                <label for="template">Mod√®le d'email :</label>
                <select id="template" class="form-control">
                    <option value="">-- S√©lectionner un mod√®le --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="subject">Sujet :</label>
                <input type="text" id="subject" name="subject" required>
            </div>
            
            <div class="form-group">
                <label for="body">Message :</label>
                <textarea id="body" name="body" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Pi√®ces jointes :</label>
                <input type="file" id="fileInput" multiple>
                <div id="attachments" class="attachments"></div>
            </div>
            
            <div>
                <button type="button" class="btn btn-secondary" onclick="window.close()">Annuler</button>
                <button type="button" class="btn" onclick="sendEmail()">Envoyer l'email</button>
            </div>
        </form>
        
        <div id="loading" class="loading">Envoi en cours...</div>
    </div>

    <script>
        // Fonction utilitaire pour r√©cup√©rer les param√®tres d'URL
        function getUrlParam(param, altParam) {
            const urlParams = new URLSearchParams(window.location.search);
            const value = urlParams.get(param) || urlParams.get(altParam) || '';
            try {
                return decodeURIComponent(value);
            } catch (e) {
                console.warn(`Erreur de d√©codage pour le param√®tre ${param}:`, e);
                return value;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Remplir les champs depuis l'URL
            const toEmail = getUrlParam('to', 'emailTo');
            if (toEmail) {
                document.getElementById('to').value = toEmail;
            }
            
            const subject = getUrlParam('subject', 'emailSubject');
            if (subject) {
                document.getElementById('subject').value = subject;
            }
            
            const body = getUrlParam('body', 'emailBody');
            if (body) {
                document.getElementById('body').value = body;
            }
            
            // Ajouter un bouton de test pour les variables
            const testButton = document.createElement('button');
            testButton.textContent = 'Tester les variables';
            testButton.type = 'button';
            testButton.style.cssText = 'margin: 10px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;';
            testButton.onclick = function() {
                // Test ultra-simple
                const original = 'Bonjour {nomClient}';
                const remplace = original.replace('{nomClient}', 'DUPONT Jean');
                
                console.log('Original:', original);
                console.log('Remplac√©:', remplace);
                
                alert('TEST SIMPLE:\n\nOriginal: ' + original + '\n\nR√©sultat: ' + remplace);
                
                // Test avec les vraies donn√©es
                const testData = {
                    nomClient: 'DUPONT Jean',
                    numeroDevis: 'DEV-2024-001'
                };
                
                const testText = 'Bonjour {nomClient}, votre devis {numeroDevis}';
                let result = testText;
                
                // Remplacement manuel
                result = result.replace('{nomClient}', testData.nomClient);
                result = result.replace('{numeroDevis}', testData.numeroDevis);
                
                alert('TEST COMPLET:\n\nTexte: ' + testText + '\n\nR√©sultat: ' + result);
                console.log('Test complet:', result);
            };
            
            document.querySelector('form').appendChild(testButton);
            
            // Charger les templates
            loadTemplates();
            
            // G√©rer la soumission du formulaire
            document.getElementById('emailForm').addEventListener('submit', function(e) {
                e.preventDefault();
                sendEmail();
            });
            
            // G√©rer la s√©lection de template
            document.getElementById('template').addEventListener('change', function() {
                const templateId = this.value;
                if (templateId) {
                    const templates = JSON.parse(localStorage.getItem('gpa_email_templates') || '[]');
                    const template = templates.find(t => t.id === templateId);
                    if (template) {
                        document.getElementById('subject').value = template.subject || '';
                        document.getElementById('body').value = template.body || '';
                    }
                }
            });
            
            // G√©rer l'ajout de pi√®ces jointes
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const files = e.target.files;
                const attachmentsContainer = document.getElementById('attachments');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const attachment = {
                            name: file.name,
                            type: file.type,
                            content: e.target.result.split(',')[1] // Supprimer le pr√©fixe base64
                        };
                        
                        // Stocker la pi√®ce jointe dans un attribut data
                        const attachmentId = 'att-' + Date.now() + '-' + i;
                        const attachmentItem = document.createElement('div');
                        attachmentItem.className = 'attachment-item';
                        attachmentItem.innerHTML = `
                            ${file.name} (${formatFileSize(file.size)})
                            <span class="remove-attachment" data-id="${attachmentId}">√ó</span>
                        `;
                        attachmentItem.dataset.attachment = JSON.stringify(attachment);
                        attachmentsContainer.appendChild(attachmentItem);
                        
                        // Ajouter un gestionnaire pour supprimer la pi√®ce jointe
                        attachmentItem.querySelector('.remove-attachment').addEventListener('click', function() {
                            attachmentItem.remove();
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                // R√©initialiser l'input file
                this.value = '';
            });
        });
        
        function loadTemplates() {
            const templateSelect = document.getElementById('template');
            const templates = JSON.parse(localStorage.getItem('gpa_email_templates') || '[]');
            
            // Vider les options existantes sauf la premi√®re
            while (templateSelect.options.length > 1) {
                templateSelect.remove(1);
            }
            
            // Ajouter les templates
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                templateSelect.appendChild(option);
            });
        }
        
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Cacher le message apr√®s 5 secondes
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function sendEmail() {
            const to = document.getElementById('to').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;
            
            // R√©cup√©rer les pi√®ces jointes
            const attachments = [];
            document.querySelectorAll('.attachment-item').forEach(item => {
                try {
                    const attachment = JSON.parse(item.dataset.attachment);
                    attachments.push({
                        filename: attachment.name,
                        content: attachment.content,
                        encoding: 'base64',
                        contentType: attachment.type
                    });
                } catch (e) {
                    console.error('Erreur lors de la lecture de la pi√®ce jointe:', e);
                }
            });
            
            // R√©cup√©rer les param√®tres SMTP depuis l'URL
            const smtpConfig = {
                host: getUrlParam('host', 'smtpHost'),
                port: parseInt(getUrlParam('port', 'smtpPort')) || 465,
                username: getUrlParam('username', 'smtpUsername'),
                password: getUrlParam('password', 'smtpPassword'),
                from: getUrlParam('from', 'smtpFrom')
            };
            
            // R√©cup√©rer les variables du devis depuis l'URL ou depuis localStorage
            const devisData = {
                nomClient: getUrlParam('nomClient', 'client_nom') || localStorage.getItem('devis_nomClient') || 'Client',
                prenomClient: getUrlParam('prenomClient', 'client_prenom') || localStorage.getItem('devis_prenomClient') || 'Pr√©nom',
                emailClient: getUrlParam('emailClient', 'client_email') || localStorage.getItem('devis_emailClient') || '',
                telephoneClient: getUrlParam('telephoneClient', 'client_telephone') || localStorage.getItem('devis_telephoneClient') || '',
                adresseClient: getUrlParam('adresseClient', 'client_adresse') || localStorage.getItem('devis_adresseClient') || '',
                vehiculeMarque: getUrlParam('vehiculeMarque', 'vehicule_marque') || localStorage.getItem('devis_vehiculeMarque') || '',
                vehiculeModele: getUrlParam('vehiculeModele', 'vehicule_modele') || localStorage.getItem('devis_vehiculeModele') || '',
                vehiculeImmat: getUrlParam('vehiculeImmat', 'vehicule_immat') || localStorage.getItem('devis_vehiculeImmat') || '',
                numeroDevis: getUrlParam('numeroDevis', 'devis_numero') || localStorage.getItem('devis_numero') || 'DEV-' + Date.now(),
                dateDevis: getUrlParam('dateDevis', 'devis_date') || localStorage.getItem('devis_dateDevis') || new Date().toLocaleDateString('fr-FR'),
                montantTotal: getUrlParam('montantTotal', 'devis_montant') || localStorage.getItem('devis_montantTotal') || '0,00 ‚Ç¨',
                formule: getUrlParam('formule', 'devis_formule') || localStorage.getItem('devis_formule') || 'Standard'
            };
            
            // D√©bogage - afficher les variables r√©cup√©r√©es
            console.log('Variables du devis:', devisData);
            
            // Fonction de substitution des variables - version simplifi√©e
            function substituteVariables(text, data) {
                let result = text;
                
                // Remplacement manuel de chaque variable
                if (data.nomClient) {
                    result = result.replace(/{nomClient}/g, data.nomClient);
                }
                if (data.prenomClient) {
                    result = result.replace(/{prenomClient}/g, data.prenomClient);
                }
                if (data.numeroDevis) {
                    result = result.replace(/{numeroDevis}/g, data.numeroDevis);
                }
                if (data.montantTotal) {
                    result = result.replace(/{montantTotal}/g, data.montantTotal);
                }
                if (data.dateDevis) {
                    result = result.replace(/{dateDevis}/g, data.dateDevis);
                }
                if (data.formule) {
                    result = result.replace(/{formule}/g, data.formule);
                }
                if (data.emailClient) {
                    result = result.replace(/{emailClient}/g, data.emailClient);
                }
                if (data.telephoneClient) {
                    result = result.replace(/{telephoneClient}/g, data.telephoneClient);
                }
                if (data.vehiculeMarque) {
                    result = result.replace(/{vehiculeMarque}/g, data.vehiculeMarque);
                }
                if (data.vehiculeModele) {
                    result = result.replace(/{vehiculeModele}/g, data.vehiculeModele);
                }
                if (data.vehiculeImmat) {
                    result = result.replace(/{vehiculeImmat}/g, data.vehiculeImmat);
                }
                
                return result;
            }
            
            // Appliquer la substitution des variables
            const processedSubject = substituteVariables(subject, devisData);
            const processedBody = substituteVariables(body, devisData);
            
            // D√©bogage - afficher les r√©sultats
            console.log('Sujet original:', subject);
            console.log('Sujet trait√©:', processedSubject);
            console.log('Corps original:', body);
            console.log('Corps trait√©:', processedBody);
            
            // Pr√©parer les donn√©es de l'email
            const emailData = {
                ...smtpConfig, // Inclure tous les param√®tres SMTP
                to: to,
                subject: processedSubject,
                body: processedBody,
                attachments: attachments,
                // Ajouter les m√©tadonn√©es suppl√©mentaires si n√©cessaire
                metadata: {
                    sentFrom: 'GPA Assurance - Envoi Email',
                    timestamp: new Date().toISOString(),
                    devisData: devisData
                }
            };
            
            // Afficher l'indicateur de chargement
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Envoyer l'email via le serveur local
                const response = await fetch('http://localhost:3001/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emailData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus('Email envoy√© avec succ√®s !', 'success');
                    // Fermer la fen√™tre apr√®s 2 secondes
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Erreur lors de l\'envoi de l\'email');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus(`Erreur: ${error.message || 'Impossible de se connecter au serveur SMTP'}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
    <!-- Charger le client d'authentification -->
    <script src="js/auth-client.js"></script>
</body>
</html>
